{
  "min_packer_version": "1.6.0",
  "variables": {
    "name": "wsipsc",
    "description": "Windows Server Insider Preview Standard, Windows Server Insider Preview Standard Core",
    "version": "2310.0.0",
    "author": "gusztavvargadr",
    "output_directory": "output",
    "download_directory": "{{env `HOME`}}/Downloads",
    "iso_url_local": "{{user `download_directory`}}/Windows_InsiderPreview_Server_vNext_en-us_25967.iso",
    "iso_url_remote": "https://app.vagrantup.com/gusztavvargadr-iso/boxes/windows-server-insider-preview/versions/2102.0.2310/providers/iso-hosted/amd64/vagrant.box",
    "iso_checksum": "sha256:e20547ac8bcca26866b2882dcbee3616851a134b0387225bebabfb87bbf1b003",
    "builder_source": "builders",
    "builder_destination": "C:/Windows/Temp/packer",
    "elevated_user": "Administrator",
    "elevated_password": "Packer42-",
    "vmware_headless": "true",
    "vmware_memory": "8192",
    "vmware_cpus": "4",
    "vmware_boot_wait": "1s",
    "vmware_communicator": "ssh",
    "vmware_communicator_username": "Administrator",
    "vmware_communicator_password": "Packer42-",
    "vmware_communicator_timeout": "30m",
    "vmware_shutdown_command": "C:/Windows/Temp/packer/shutdown.cmd",
    "vmware_shutdown_timeout": "10m",
    "vmware_guest_os_type": "",
    "vmware_disk_size": "130048",
    "vmware_floppy_files": "builders/vmware-iso/floppy/*",
    "vmware_boot_command": "<enter><wait><enter><wait><enter>",
    "chef_source": "provisioners/chef",
    "chef_destination": "C:/Windows/Temp/chef",
    "chef_start_retry_timeout": "30m",
    "chef_max_retries": "10"
  },
  "description": "{{user `description`}}",
  "builders": [
    {
      "type": "vmware-iso",
      "vm_name": "{{user `author`}}-{{user `name`}}-{{user `version`}}-{{timestamp}}",
      "guest_os_type": "{{user `vmware_guest_os_type`}}",
      "iso_urls": [
        "{{user `iso_url_local`}}",
        "{{user `iso_url_remote`}}"
      ],
      "iso_checksum": "{{user `iso_checksum`}}",
      "headless": "{{user `vmware_headless`}}",
      "vmx_data": {
        "firmware": "efi",
        "vhv.enable": "FALSE"
      },
      "version": "16",
      "disk_type_id": 0,
      "disk_adapter_type": "nvme",
      "memory": "{{user `vmware_memory`}}",
      "cpus": "{{user `vmware_cpus`}}",
      "disk_size": "{{user `vmware_disk_size`}}",
      "floppy_files": [
        "{{user `vmware_floppy_files`}}"
      ],
      "boot_wait": "{{user `vmware_boot_wait`}}",
      "boot_command": [
        "{{ user `vmware_boot_command` }}"
      ],
      "boot_keygroup_interval": "1s",
      "communicator": "{{user `vmware_communicator`}}",
      "ssh_username": "{{user `vmware_communicator_username`}}",
      "ssh_password": "{{user `vmware_communicator_password`}}",
      "ssh_timeout": "{{user `vmware_communicator_timeout`}}",
      "winrm_username": "{{user `vmware_communicator_username`}}",
      "winrm_password": "{{user `vmware_communicator_password`}}",
      "winrm_timeout": "{{user `vmware_communicator_timeout`}}",
      "shutdown_command": "{{user `vmware_shutdown_command`}}",
      "shutdown_timeout": "{{user `vmware_shutdown_timeout`}}",
      "output_directory": "{{user `output_directory`}}/build"
    }
  ],
  "provisioners": [
    {
      "type": "powershell",
      "script": "{{user `builder_source`}}/{{build_type}}/scripts/prepare.ps1"
    },
    {
      "type": "file",
      "source": "{{user `builder_source`}}/{{build_type}}/upload/",
      "destination": "{{user `builder_destination`}}"
    },
    {
      "type": "powershell",
      "script": "{{user `chef_source`}}/scripts/prepare.ps1",
      "elevated_user": "{{user `elevated_user`}}",
      "elevated_password": "{{user `elevated_password`}}"
    },
    {
      "type": "file",
      "source": "{{user `chef_source`}}/upload/",
      "destination": "{{user `chef_destination`}}"
    },
    {
      "type": "powershell",
      "inline": [
        "cd {{user `chef_destination`}}; chef-client --local-mode"
      ],
      "elevated_user": "{{user `elevated_user`}}",
      "elevated_password": "{{user `elevated_password`}}",
      "pause_before": "1m",
      "start_retry_timeout": "{{user `chef_start_retry_timeout`}}",
      "max_retries": "{{user `chef_max_retries`}}"
    },
    {
      "type": "powershell",
      "script": "{{user `chef_source`}}/scripts/cleanup.ps1",
      "elevated_user": "{{user `elevated_user`}}",
      "elevated_password": "{{user `elevated_password`}}"
    }
  ],
  "post-processors": [
    {
      "type": "manifest",
      "output": "{{user `output_directory`}}/build/manifest.json"
    },
    {
      "type": "checksum",
      "checksum_types": [
        "sha256"
      ],
      "output": "{{user `output_directory`}}/build/checksum.{{.ChecksumType}}"
    }
  ]
}